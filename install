#!/usr/bin/env bash

if [[ -z $STOW_FOLDERS ]]; then
	STOW_FOLDERS=("alacritty" "git" "i3" "nvim" "ranger" "tealdeer" "tmux" "zsh")
fi

remove_conflicts() {
	local folder=$1
	stow -n "$folder" 2>&1 |
		grep -E '^\s+\* existing target' |
		sed -E 's/^.*: (.*)$/\1/' |
		while read -r relpath; do
			path="$HOME/$relpath"
			if [[ -e $path || -L $path ]]; then
				echo "Removing conflicting path: $path"
				rm -rf "$path"
			fi
		done
}

for folder in "${STOW_FOLDERS[@]}"; do
	remove_conflicts "$folder"
	stow -D "$folder" 2>/dev/null || true
	stow "$folder"
done

if [[ -d "$HOME"/snap/btop ]]; then
	# Btop contains symlinks therefore needs to be treated separately
	remove_conflicts "btop"
	stow --target="$HOME"/snap/btop/current btop
fi
